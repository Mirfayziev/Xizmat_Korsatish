{% extends "base.html" %}
{% block content %}

<h3 class="mb-4">üìù Buyurtma #{{ order.id }}</h3>

<div class="row">

    <!-- LEFT SIDE ‚Äî ORDER INFO -->
    <div class="col-md-6">

        <div class="card shadow-sm mb-4">
            <div class="card-body">

                <h5 class="mb-3">üìå Buyurtma ma‚Äôlumotlari</h5>

                <p><b>Kategoriya:</b> {{ order.category.name if order.category else "-" }}</p>
                <p><b>Xizmat:</b> {{ order.service.name if order.service else "-" }}</p>
                <p><b>Narx:</b> {{ order.service.price if order.service else "" }} so‚Äòm</p>
                <p><b>Mijoz raqami:</b> {{ order.phone }}</p>

                <p><b>Izoh:</b><br> {{ order.comment }}</p>

                <p><b>To‚Äòlov:</b> {{ order.payment_method }}</p>

                <p><b>Joylashuv:</b><br>
                    {% if order.location_lat %}
                    <a target="_blank"
                       href="https://www.google.com/maps?q={{ order.location_lat }},{{ order.location_lng }}">
                        üìç Google Maps‚Äôda ochish
                    </a>
                    {% else %}
                    <i>Lokatsiya yo‚Äòq</i>
                    {% endif %}
                </p>

                <p><b>Status:</b>
                    <span class="badge bg-dark">{{ order.status.value }}</span>
                </p>

                <!-- STATUS FORM -->
                <form method="POST" class="mt-3">
                    <input type="hidden" name="action" value="status">

                    <div class="row">
                        <div class="col-md-8">
                            <select name="status" class="form-select">
                                {% for s in OrderStatus %}
                                <option value="{{ s.value }}"
                                    {% if order.status == s %}selected{% endif %}>
                                    {{ s.value }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <button class="btn btn-dark w-100">O‚Äòzgartirish</button>
                        </div>
                    </div>
                </form>

            </div>
        </div>


        <!-- CHAT BOX -->
        <div class="card shadow-sm">
            <div class="card-body">

                <h5 class="mb-3">üí¨ Muloqot (Admin ‚Üî Mijoz)</h5>

                <div style="max-height: 300px; overflow-y: auto; padding-right: 10px;">
                    {% for m in messages %}
                    <div class="mb-3 p-2 {% if m.from_admin %}bg-dark text-white{% else %}bg-light{% endif %}"
                         style="border-radius: 8px;">
                        <small>
                            {% if m.from_admin %}Admin:{% else %}Mijoz:{% endif %}
                        </small><br>
                        {{ m.text }}
                        <div><small class="text-secondary">{{ m.created_at }}</small></div>
                    </div>
                    {% endfor %}
                </div>

                <form method="POST" class="mt-3">
                    <input type="hidden" name="action" value="send_message">
                    <textarea name="text" class="form-control mb-2" placeholder="Xabar yuborish..." required></textarea>
                    <button class="btn btn-dark w-100">Yuborish</button>
                </form>

            </div>
        </div>

    </div>




    <!-- RIGHT SIDE ‚Äî AI ANALYSIS -->
    <div class="col-md-6">

        <!-- UPLOAD AUDIO -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">

                <h5 class="mb-3">ü§ñ AI Audio Tahlil</h5>

                <form method="POST"
                      action="/admin/upload_audio/{{ order.id }}/client"
                      enctype="multipart/form-data"
                      class="mb-3">

                    <label class="form-label">üéß Mijoz audiosi (review)</label>
                    <input type="file" name="audio" class="form-control mb-2" required>
                    <button class="btn btn-primary w-100">AI tahlil qil (Mijoz)</button>
                </form>

                <form method="POST"
                      action="/admin/upload_audio/{{ order.id }}/master"
                      enctype="multipart/form-data">

                    <label class="form-label">üßë‚Äçüîß Usta audiosi (hisobot)</label>
                    <input type="file" name="audio" class="form-control mb-2" required>
                    <button class="btn btn-warning w-100">AI tahlil qil (Usta)</button>
                </form>

            </div>
        </div>


        <!-- AI RESULTS LIST -->
        <div class="card shadow-sm">
            <div class="card-body">

                <h5 class="mb-3">üìà AI natijalari</h5>

                {% if ai_data %}
                    {% for ai in ai_data %}
                    <div class="mb-3 p-3 bg-light" style="border-radius:8px;">

                        <p><b>Audio turi:</b> {{ ai.audio_type }}</p>
                        <p><b>Transcript:</b><br> {{ ai.transcript }}</p>
                        <p><b>AI Xulosa:</b><br> {{ ai.ai_summary }}</p>
                        <p><b>Sentiment:</b> {{ ai.sentiment_score }}/100</p>
                        <p><b>Sifat:</b> {{ ai.quality_score }}/100</p>

                        {% if ai.audio_type == "master" %}
                        <p><b>Qiyinchilik:</b> {{ ai.difficulty }}/10</p>
                        <p><b>Materiallar:</b> {{ ai.materials_used }}</p>
                        <p><b>Qo‚Äòshimcha xarajat:</b> {{ ai.extra_cost }}</p>
                        {% endif %}

                        <p><b>Tavsiyalar:</b><br> {{ ai.recommended }}</p>

                        <small class="text-secondary">{{ ai.created_at }}</small>
                    </div>
                    {% endfor %}
                {% else %}
                    <i>AI hali tahlil qilmagan.</i>
                {% endif %}

            </div>
        </div>

    </div>
</div>

{% endblock %}
